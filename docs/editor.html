<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>劇の立ち位置エディター</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
    #controls { width: 280px; background: #f8f8f8; padding: 10px; overflow-y: auto; }
    #stage { flex: 1; background: #eee; position: relative; }
    .actor { position: absolute; width: 60px; height: 60px;
             border-radius: 50%; background: lightblue;
             display: flex; align-items: center; justify-content: center;
             cursor: move; border: 2px solid #555; }
    .actor.selected { background: orange; }
    .actor-button { margin: 2px 0; display: flex; gap: 3px; }
    button { cursor: pointer; }
    input { width: 100%; margin: 3px 0; }
    .section { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="controls">
    <div class="section">
      <h3>役者追加</h3>
      <input id="newActor" placeholder="役者名" onkeypress="if(event.key==='Enter'){addActor();}">
      <button onclick="addActor()">追加</button>
      <div id="actor-list"></div>
    </div>

    <div class="section">
      <h3>シーン管理</h3>
      <input id="newScene" placeholder="シーン名" onkeypress="if(event.key==='Enter'){addScene();}">
      <button onclick="addScene()">追加</button>
      <div id="scene-list"></div>
    </div>

    <div class="section">
      <h3>セリフ番号</h3>
      <input id="lineNumber" type="number" min="1" max="113" value="1"
             onkeypress="if(event.key==='Enter'){setLineNumber();}">
      <button onclick="setLineNumber()">移動</button>
    </div>

    <div class="section">
      <h3>まとめ操作</h3>
      <button onclick="copyAllPositions()">全部コピー</button>
      <button onclick="pasteAllPositions()">全部ペースト</button>
    </div>

    <div class="section">
      <button onclick="saveToCookie()">保存</button>
      <button onclick="loadFromCookie()">読込</button>
    </div>
  </div>

  <div id="stage"></div>

  <script>
    // データ保持
    let data = { scenes: {} };
    let currentScene = null;
    let currentLine = 1;
    let selectedActor = null;
    let copiedPosition = null;
    let copiedAllPositions = null; // ★ 全体コピー用

    function addActor(){
      const name=document.getElementById("newActor").value.trim();
      if(!name) return;
      if(!data.actors) data.actors=[];
      if(!data.actors.includes(name)) data.actors.push(name);
      document.getElementById("newActor").value="";
      renderActors();
    }

    function addScene(){
      const name=document.getElementById("newScene").value.trim();
      if(!name) return;
      if(!data.scenes[name]) data.scenes[name]={};
      currentScene=name;
      document.getElementById("newScene").value="";
      renderScenes();
      renderActors();
    }

    function setLineNumber(){
      currentLine=parseInt(document.getElementById("lineNumber").value)||1;
      renderActors();
    }

    function renderScenes(){
      const list=document.getElementById("scene-list");
      list.innerHTML="";
      Object.keys(data.scenes).forEach(scene=>{
        const btn=document.createElement("button");
        btn.textContent=scene;
        btn.onclick=()=>{ currentScene=scene; renderActors(); };
        if(currentScene===scene) btn.style.fontWeight="bold";
        list.appendChild(btn);
      });
    }

    function renderActors(){
      const stage=document.getElementById("stage");
      stage.innerHTML="";
      if(!currentScene) return;
      const scene=data.scenes[currentScene];
      if(!scene[currentLine]) scene[currentLine]={};
      const actorsObj=scene[currentLine];
      const names=data.actors||[];

      // ステージ上
      for(const name in actorsObj){
        const pos=actorsObj[name];
        const div=document.createElement("div");
        div.className="actor"+(selectedActor===name?" selected":"");
        div.style.left=pos.x+"px"; div.style.top=pos.y+"px";
        div.textContent=name;
        makeDraggable(div,name);
        stage.appendChild(div);
      }

      // 役者リスト
      const list=document.getElementById("actor-list");
      list.innerHTML="";
      names.forEach(name=>{
        const wrapper=document.createElement("div");
        wrapper.className="actor-button";

        const btn=document.createElement("button");
        btn.textContent=name;
        btn.onclick=()=>{ selectedActor=(selectedActor===name)?null:name; renderActors(); };

        const copy=document.createElement("button");
        copy.textContent="コピー";
        copy.onclick=()=>{
          if(actorsObj[name]) copiedPosition={...actorsObj[name]};
        };

        const paste=document.createElement("button");
        paste.textContent="ペースト";
        paste.onclick=()=>{
          if(copiedPosition){
            actorsObj[name]={...copiedPosition};
            renderActors();
          }
        };

        const del=document.createElement("button");
        del.textContent="削除";
        del.onclick=()=>{ delete actorsObj[name]; renderActors(); };

        wrapper.appendChild(btn);
        wrapper.appendChild(copy);
        wrapper.appendChild(paste);
        wrapper.appendChild(del);
        list.appendChild(wrapper);
      });
    }

    function makeDraggable(el,name){
      let offsetX,offsetY;
      el.onmousedown=(e)=>{
        offsetX=e.offsetX; offsetY=e.offsetY;
        document.onmousemove=(ev)=>{
          el.style.left=(ev.pageX-offsetX-280)+"px";
          el.style.top=(ev.pageY-offsetY)+"px";
        };
        document.onmouseup=(ev)=>{
          document.onmousemove=null;
          const x=ev.pageX-offsetX-280;
          const y=ev.pageY-offsetY;
          data.scenes[currentScene][currentLine][name]={x,y};
        };
      };
    }

    // --- 全体コピー・ペースト ---
    function copyAllPositions(){
      if(!currentScene) return;
      const scene=data.scenes[currentScene];
      if(!scene[currentLine]) return;
      copiedAllPositions=JSON.parse(JSON.stringify(scene[currentLine]));
    }

    function pasteAllPositions(){
      if(!currentScene || !copiedAllPositions) return;
      const scene=data.scenes[currentScene];
      scene[currentLine]=JSON.parse(JSON.stringify(copiedAllPositions));
      renderActors();
    }

    // --- 保存・読込 ---
    function saveToCookie(){
      document.cookie="playData="+encodeURIComponent(JSON.stringify(data))+"; path=/";
      alert("保存しました");
    }

    function loadFromCookie(){
      const match=document.cookie.match(/playData=([^;]+)/);
      if(match){
        data=JSON.parse(decodeURIComponent(match[1]));
        renderScenes();
        renderActors();
        alert("読み込み完了");
      }
    }
  </script>
</body>
</html>
