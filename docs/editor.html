<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>立ち位置可視化ツール（自動保存版）</title>
<style>
body { font-family:sans-serif; display:flex; gap:20px; background:#f0f0f0; margin:0; padding:10px; }
.container { background:white; padding:15px; border-radius:8px; box-shadow:0 3px 8px rgba(0,0,0,0.2); width:300px; }
h3,h4 { margin:5px 0; }
#stage-container { flex-grow:1; }
#stage { width:700px; height:500px; background:#eee; border:2px solid #aaa; position:relative;
         background-image: linear-gradient(0deg, transparent 24%, #ccc 25%, #ccc 26%, transparent 27%, transparent 74%, #ccc 75%, #ccc 76%, transparent 77%, transparent),
                           linear-gradient(90deg, transparent 24%, #ccc 25%, #ccc 26%, transparent 27%, transparent 74%, #ccc 75%, #ccc 76%, transparent 77%, transparent);
         background-size:50px 50px; }
.actor { width:50px;height:50px;border-radius:50%;background:#3498db;color:white;display:flex;align-items:center;justify-content:center;position:absolute;cursor:grab; }
.hidden { opacity:0.1; }
button { margin:2px; cursor:pointer; }
.actor-button { display:flex; justify-content:space-between; align-items:center; margin-bottom:3px; }
.flex-row { display:flex; gap:5px; }
textarea,input { width:100%; margin-bottom:5px; padding:5px; border-radius:4px; border:1px solid #ccc; box-sizing:border-box; }
</style>
</head>
<body>

<div class="container">
  <h3>シーン</h3>
  <div id="scene-list"></div>
  <button onclick="addScene()">＋シーン追加</button>
  <textarea id="scene-memo" placeholder="シーンのメモ"></textarea>

  <h4>セリフ</h4>
  <div id="line-list"></div>
  <div class="flex-row">
    <input id="new-line" placeholder="セリフ内容">
    <button onclick="addLine()">＋追加</button>
  </div>
  <div class="flex-row">
    <input id="line-number" type="number" min="1" max="113" placeholder="セリフ番号">
    <button onclick="jumpLine()">ジャンプ</button>
  </div>

  <h4>役者（共通プール）</h4>
  <div id="actors-pool"></div>
  <div class="flex-row">
    <input id="new-actor" placeholder="役者名">
    <button onclick="addActorPool()">＋追加</button>
  </div>

  <button onclick="exportData()">エクスポート</button>
  <input type="file" onchange="importData(event)">
</div>

<div id="stage-container" class="container">
  <h3>ステージ</h3>
  <div id="stage"></div>

  <h4>役者表示切替</h4>
  <div id="actor-list"></div>
  <button onclick="showAllActors()">全員表示</button>
</div>

<script>
let actorsPool = [];
let scenes = [{ memo:"", lines:[{ text:"", actors:{} }] }];
let currentScene=0, currentLine=0, selectedActor=null;
let dragIndex=null;

// --- localStorage 自動保存 ---
function saveData() {
  const data = { actorsPool, scenes };
  localStorage.setItem("blockingData", JSON.stringify(data));
}

function loadData() {
  const saved = localStorage.getItem("blockingData");
  if (saved) {
    const obj = JSON.parse(saved);
    actorsPool = obj.actorsPool || [];
    scenes = obj.scenes || [{ memo:"", lines:[{ text:"", actors:{} }] }];
  }
}

// --- シーン ---
function addScene() {
  scenes.push({ memo:"", lines:[{ text:"", actors:{} }] });
  currentScene = scenes.length - 1;
  renderScenes();
  renderActors();
  saveData();
}

function renderScenes(){
  const list = document.getElementById("scene-list");
  list.innerHTML="";
  scenes.forEach((s,i)=>{
    const btn=document.createElement("button");
    btn.textContent="シーン "+(i+1);
    btn.onclick=()=>{ scenes[currentScene].memo=document.getElementById("scene-memo").value; currentScene=i; currentLine=0; renderScenes(); renderLines(); renderActors(); saveData(); }
    if(i===currentScene) btn.style.fontWeight="bold";
    list.appendChild(btn);
  });
  document.getElementById("scene-memo").value=scenes[currentScene].memo;
  renderLines();
  renderActors();
}

// --- セリフ ---
function renderLines(){
  const list=document.getElementById("line-list");
  list.innerHTML="";
  scenes[currentScene].lines.forEach((l,i)=>{
    const btn=document.createElement("button");
    btn.textContent=l.text||"（空のセリフ）";
    btn.onclick=()=>{ currentLine=i; renderLines(); renderActors(); saveData(); };
    if(i===currentLine) btn.style.fontWeight="bold";
    list.appendChild(btn);
    const del=document.createElement("button");
    del.textContent="削除";
    del.onclick=()=>{ scenes[currentScene].lines.splice(i,1); currentLine=0; renderLines(); renderActors(); saveData(); };
    list.appendChild(del);
  });
}

function addLine(){
  const text=document.getElementById("new-line").value.trim();
  if(!text) return;
  scenes[currentScene].lines.push({ text, actors:{} });
  document.getElementById("new-line").value="";
  currentLine=scenes[currentScene].lines.length-1;
  renderLines();
  renderActors();
  saveData();
}

function jumpLine(){
  const num=parseInt(document.getElementById("line-number").value,10);
  if(!isNaN(num) && num>=1 && num<=scenes[currentScene].lines.length){
    currentLine=num-1;
    renderLines();
    renderActors();
    saveData();
  }
}

// --- 役者共通 ---
function renderActorPool(){
  const list=document.getElementById("actors-pool");
  list.innerHTML="";
  actorsPool.forEach(name=>{
    const btn=document.createElement("button");
    btn.textContent=name;
    btn.onclick=()=>{ addActorToLine(name); saveData(); };
    list.appendChild(btn);
  });
}

function addActorPool(){
  const name=document.getElementById("new-actor").value.trim();
  if(!name || actorsPool.includes(name)) return;
  actorsPool.push(name);
  document.getElementById("new-actor").value="";
  renderActorPool();
  saveData();
}

function addActorToLine(name){
  const line=scenes[currentScene].lines[currentLine];
  if(!line.actors[name]) line.actors[name]={x:50,y:50};
  renderActors();
  saveData();
}

// --- ステージ表示 ---
function renderActors(){
  const stage=document.getElementById("stage");
  stage.innerHTML="";
  const actorsObj=scenes[currentScene].lines[currentLine].actors;
  const names=Object.keys(actorsObj);
  names.forEach((name)=>{
    if(selectedActor && selectedActor!==name) return;
    const a=actorsObj[name];
    const div=document.createElement("div");
    div.className="actor";
    div.textContent=name;
    div.style.left=a.x+"px";
    div.style.top=a.y+"px";
    div.onmousedown=(e)=>{ dragIndex=name; document.onmousemove=drag; document.onmouseup=stopDrag; };
    stage.appendChild(div);
  });

  const list=document.getElementById("actor-list");
  list.innerHTML="";
  names.forEach(name=>{
    const wrapper=document.createElement("div");
    wrapper.className="actor-button";
    const btn=document.createElement("button");
    btn.textContent=name;
    btn.onclick=()=>{ selectedActor = (selectedActor===name)?null:name; renderActors(); };
    const del=document.createElement("button");
    del.textContent="削除";
    del.onclick=()=>{ delete actorsObj[name]; renderActors(); saveData(); };
    wrapper.appendChild(btn);
    wrapper.appendChild(del);
    list.appendChild(wrapper);
  });
}

// --- ドラッグ ---
function drag(e){
  const a=scenes[currentScene].lines[currentLine].actors[dragIndex];
  a.x=e.pageX - document.getElementById("stage").offsetLeft - 25;
  a.y=e.pageY - document.getElementById("stage").offsetTop - 25;
  renderActors();
}

function stopDrag(){ document.onmousemove=null; document.onmouseup=null; dragIndex=null; saveData(); }

// --- 表示切替 ---
function showAllActors(){ selectedActor=null; renderActors(); }

// --- データ入出力 ---
function exportData(){
  const data={actorsPool, scenes};
  const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="blocking.json";
  a.click();
}

function importData(event){
  const file=event.target.files[0];
  const reader=new FileReader();
  reader.onload=(e)=>{
    const obj=JSON.parse(e.target.result);
    actorsPool=obj.actorsPool||[];
    scenes=obj.scenes||[{ memo:"", lines:[{text:"",actors:{}}] }];
    currentScene=0; currentLine=0;
    renderActorPool();
    renderScenes();
    renderActors();
    saveData();
  };
  reader.readAsText(file);
}

// --- Enterキーで登録 ---
document.getElementById("new-actor").addEventListener("keydown", e=>{
  if(e.key==="Enter") addActorPool();
});
document.getElementById("new-line").addEventListener("keydown", e=>{
  if(e.key==="Enter") addLine();
});

document.getElementById("scene-memo").addEventListener("input", e=>{
  scenes[currentScene].memo=e.target.value;
  saveData();
});

// --- 初回ロード ---
loadData();
renderActorPool();
renderScenes();

</script>
</body>
</html>
