<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>閲覧用: 舞台演出ビューア</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f9f9f9; }
    .section { margin-bottom: 15px; }
    #stage { border: 1px solid #333; background: #fff; margin-top: 10px; }
    #actorsList { margin-top: 10px; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; }
    textarea { width: 100%; resize: vertical; }
  </style>
</head>
<body>
  <h2>閲覧用ビューア</h2>

  <div class="section">
    <label>シーン選択:
      <select id="sceneSelect"></select>
    </label>
    <label>セリフ番号:
      <input type="number" id="lineInput" min="1" value="1" style="width:60px;">
      <button id="goLine">ジャンプ</button>
    </label>
  </div>

  <div class="section">
    <canvas id="stage" width="600" height="400"></canvas>
    <div id="actorsList"></div>
  </div>

  <div class="section">
    <h4>セリフメモ</h4>
    <textarea id="lineMemo" rows="3" readonly placeholder="このセリフのメモ (編集不可)"></textarea>
  </div>

  <div class="section">
    <button id="prevLine">← 前のセリフ</button>
    <button id="nextLine">次のセリフ →</button>
  </div>

  <div class="section">
    <h4>データ読込</h4>
    <input type="file" id="importFile">
  </div>

<script>
let data = { actors: [], scenes: {} };
let currentScene = null;
let currentLine = 1;

function renderScene() {
  if (!currentScene) return;
  const sceneData = data.scenes[currentScene];
  if (!sceneData || !sceneData.lines[currentLine]) return;

  const lineData = sceneData.lines[currentLine];

  // Canvas
  const canvas = document.getElementById("stage");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (const actor in lineData.actors) {
    const {x,y} = lineData.actors[actor];
    ctx.beginPath();
    ctx.arc(x, y, 15, 0, Math.PI*2);
    ctx.fillStyle = "skyblue";
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle = "black";
    ctx.fillText(actor, x-10, y-20);
  }

  // リスト
  const list = document.getElementById("actorsList");
  list.innerHTML = `<b>セリフ ${currentLine}</b><br>` +
    Object.entries(lineData.actors).map(([a,pos]) => 
      `${a}: (${pos.x},${pos.y})`).join("<br>");

  // メモ
  const memoBox = document.getElementById("lineMemo");
  memoBox.value = lineData.memo || "";
}

function changeLine(newLine) {
  const sceneData = data.scenes[currentScene];
  if (!sceneData) return;
  if (!sceneData.lines[newLine]) return;
  currentLine = newLine;
  document.getElementById("lineInput").value = newLine;
  renderScene();
}

document.getElementById("goLine").onclick = ()=>{
  changeLine(parseInt(document.getElementById("lineInput").value));
};
document.getElementById("prevLine").onclick = ()=>{
  changeLine(currentLine-1);
};
document.getElementById("nextLine").onclick = ()=>{
  changeLine(currentLine+1);
};

document.getElementById("sceneSelect").onchange = (e)=>{
  currentScene = e.target.value;
  currentLine = 1;
  renderScene();
};

// データ読込
document.getElementById("importFile").onchange = (e)=>{
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = (evt)=>{
    try {
      data = JSON.parse(evt.target.result);
      // シーン選択更新
      const sceneSelect = document.getElementById("sceneSelect");
      sceneSelect.innerHTML = Object.keys(data.scenes)
        .map(s=>`<option>${s}</option>`).join("");
      currentScene = Object.keys(data.scenes)[0];
      currentLine = 1;
      renderScene();
    } catch(err) {
      alert("読み込み失敗: " + err);
    }
  };
  reader.readAsText(file);
};
</script>
</body>
</html>
